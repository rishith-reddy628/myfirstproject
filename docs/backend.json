{
  "entities": {
    "Craft": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Craft",
      "type": "object",
      "description": "Represents a craft idea, either created by a user or generated by AI.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the craft."
        },
        "title": {
          "type": "string",
          "description": "Title of the craft."
        },
        "type": {
          "type": "string",
          "description": "Type of craft."
        },
        "material": {
          "type": "string",
          "description": "Main material used in the craft."
        },
        "videoLink": {
          "type": "string",
          "description": "Link to a YouTube video tutorial for the craft.",
          "format": "uri"
        },
        "description": {
          "type": "string",
          "description": "Detailed description of the craft."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Craft) The user who created the craft."
        },
        "ratingIds": {
          "type": "array",
          "description": "References to Ratings. (Relationship: Craft 1:N Rating) The ratings associated with the craft.",
          "items": {
            "type": "string"
          }
        },
        "imageURL": {
          "type": "string",
          "description": "URL of the craft image stored in Firebase Storage.",
          "format": "uri"
        }
      },
      "required": [
        "id",
        "title",
        "material",
        "videoLink",
        "description",
        "userId"
      ]
    },
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user profile.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "displayName": {
          "type": "string",
          "description": "User's display name."
        },
        "craftIds": {
          "type": "array",
          "description": "References to Crafts. (Relationship: User 1:N Craft) Crafts created by this user.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "email",
        "displayName"
      ]
    },
    "Rating": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Rating",
      "type": "object",
      "description": "Represents a rating given to a craft.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the rating."
        },
        "craftId": {
          "type": "string",
          "description": "Reference to Craft. (Relationship: Craft 1:N Rating) The craft being rated."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Rating) The user who gave the rating."
        },
        "score": {
          "type": "number",
          "description": "The rating score."
        },
        "comment": {
          "type": "string",
          "description": "Optional comment accompanying the rating."
        }
      },
      "required": [
        "id",
        "craftId",
        "userId",
        "score"
      ]
    },
    "WasteArticle": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "WasteArticle",
      "type": "object",
      "description": "Represents an article about waste management.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the waste article."
        },
        "title": {
          "type": "string",
          "description": "Title of the article."
        },
        "content": {
          "type": "string",
          "description": "Content of the article."
        },
        "date": {
          "type": "string",
          "description": "Date the article was published.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "title",
        "content",
        "date"
      ]
    },
    "MarketplaceListing": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "MarketplaceListing",
      "type": "object",
      "description": "Represents a listing in the marketplace for eco-friendly crafts.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the marketplace listing."
        },
        "name": {
          "type": "string",
          "description": "Name of the product."
        },
        "price": {
          "type": "number",
          "description": "Price of the product."
        },
        "imageURL": {
          "type": "string",
          "description": "URL of the product image stored in Firebase Storage.",
          "format": "uri"
        },
        "description": {
          "type": "string",
          "description": "Description of the product."
        },
        "sellerId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N MarketplaceListing) The user selling the product."
        }
      },
      "required": [
        "id",
        "name",
        "price",
        "imageURL",
        "description",
        "sellerId"
      ]
    },
    "CommunityPost": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CommunityPost",
      "type": "object",
      "description": "Represents a post in the community section where users can share their crafts.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the community post."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N CommunityPost) The user who created the post."
        },
        "craftId": {
          "type": "string",
          "description": "Reference to Craft. The craft being showcased in the post."
        },
        "imageURL": {
          "type": "string",
          "description": "URL of the craft image stored in Firebase Storage.",
          "format": "uri"
        },
        "caption": {
          "type": "string",
          "description": "Caption for the post."
        },
        "commentIds": {
          "type": "array",
          "description": "References to Comments. (Relationship: CommunityPost 1:N Comment) Comments associated with this post.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "userId",
        "craftId",
        "imageURL",
        "caption"
      ]
    },
    "Comment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Comment",
      "type": "object",
      "description": "Represents a comment on a community post.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the comment."
        },
        "postId": {
          "type": "string",
          "description": "Reference to CommunityPost. (Relationship: CommunityPost 1:N Comment) The post this comment belongs to."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Comment) The user who created the comment."
        },
        "text": {
          "type": "string",
          "description": "Text content of the comment."
        },
        "date": {
          "type": "string",
          "description": "Date the comment was published.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "postId",
        "userId",
        "text",
        "date"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profiles.  The 'userId' parameter corresponds to the Firebase Auth UID.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier for the user, matching the Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/crafts/{craftId}",
        "definition": {
          "entityName": "Craft",
          "schema": {
            "$ref": "#/backend/entities/Craft"
          },
          "description": "Stores craft ideas created by users. The 'userId' indicates the owner, enabling path-based access control. This path structure enables authorization independence.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who created the craft."
            },
            {
              "name": "craftId",
              "description": "The unique identifier for the craft."
            }
          ]
        }
      },
      {
        "path": "/ratings/{ratingId}",
        "definition": {
          "entityName": "Rating",
          "schema": {
            "$ref": "#/backend/entities/Rating"
          },
          "description": "Stores ratings given to crafts. Does not implement path-based ownership because all ratings are accessible. Includes 'craftId' for querying.",
          "params": [
            {
              "name": "ratingId",
              "description": "The unique identifier for the rating."
            }
          ]
        }
      },
      {
        "path": "/waste_articles/{wasteArticleId}",
        "definition": {
          "entityName": "WasteArticle",
          "schema": {
            "$ref": "#/backend/entities/WasteArticle"
          },
          "description": "Stores articles about waste management. Accessible to admins.",
          "params": [
            {
              "name": "wasteArticleId",
              "description": "The unique identifier for the waste article."
            }
          ]
        }
      },
      {
        "path": "/marketplace_listings/{marketplaceListingId}",
        "definition": {
          "entityName": "MarketplaceListing",
          "schema": {
            "$ref": "#/backend/entities/MarketplaceListing"
          },
          "description": "Stores marketplace listings. Includes 'sellerId' and is used for filtering and ownership checks. Users can view the listings. Path structure enables authorization independence.",
          "params": [
            {
              "name": "marketplaceListingId",
              "description": "The unique identifier for the marketplace listing."
            }
          ]
        }
      },
      {
        "path": "/community_posts/{communityPostId}",
        "definition": {
          "entityName": "CommunityPost",
          "schema": {
            "$ref": "#/backend/entities/CommunityPost"
          },
          "description": "Stores community posts. Includes 'userId' to identify the post creator and 'craftId' to reference the craft being showcased. This path structure provides authorization independence.",
          "params": [
            {
              "name": "communityPostId",
              "description": "The unique identifier for the community post."
            }
          ]
        }
      },
      {
        "path": "/community_posts/{communityPostId}/comments/{commentId}",
        "definition": {
          "entityName": "Comment",
          "schema": {
            "$ref": "#/backend/entities/Comment"
          },
          "description": "Stores comments for community posts. Includes 'userId' to identify the commenter and 'postId' for linking comments to posts.",
          "params": [
            {
              "name": "communityPostId",
              "description": "The unique identifier for the community post."
            },
            {
              "name": "commentId",
              "description": "The unique identifier for the comment."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to support the EcoCrafter application, focusing on craft management, user authentication, community interaction, and waste management articles. The core principle is Authorization Independence, achieved through denormalization of user IDs where necessary. User-generated crafts are stored under their respective user IDs, ensuring secure and easily manageable data access. The community posts include the userId and craftId, and comments include the postId and userId which ensure proper linking and access control. Here is a breakdown of how the design satisfies the core principles:\n\n1.  **Authorization Independence:** The structure avoids `get()` calls in security rules by denormalizing user IDs. For instance, crafts are stored under `/users/{userId}/crafts/{craftId}`, making it straightforward to verify ownership using `request.auth.uid == userId` without needing to read the user document.  Community posts and comments follow a similar pattern.\n\n2.  **Clarity of Intent:** The path structure clearly reflects data ownership and relationships.  `/users/{userId}/crafts/{craftId}` immediately indicates that a craft belongs to a specific user.\n\n3.  **DBAC (No Custom Claims):** Authorization is based solely on `request.auth.uid` and the document paths. There are no global roles or custom claims used.\n\n4.  **QAPs (Rules are not Filters):** The structure supports secure `list` operations.  Listing crafts under `/users/{userId}/crafts` can be secured by verifying that `request.auth.uid == userId` which gives users the ability to only list their own crafts. The marketplace listings follow a similar pattern, allowing users to only view or edit their own listings.\n\n5.  **Invariants:** The path structure enforces ownership invariants.  A craft stored under `/users/{userId}/crafts/{craftId}` inherently belongs to that user. Timestamps (if included) and other denormalized data can be validated in security rules during creation and updates."
  }
}